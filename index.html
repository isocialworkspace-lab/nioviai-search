<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niovi AI - Strategic Workspace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-nav: #0f172a;
            --bg-sidebar: #f8fafc;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --accent-blue: #2563eb;
            --border: #e2e8f0;
            --sidebar-width: 320px;
            --nav-width: 80px;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; color: var(--text-main); background: #fff; overflow: hidden; }

        /* NAV */
        .global-nav { width: var(--nav-width); background: var(--bg-nav); display: flex; flex-direction: column; align-items: center; padding: 24px 0; gap: 8px; flex-shrink: 0; }
        .logo-img { width: 44px; height: 44px; border-radius: 12px; margin-bottom: 16px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; color: #94a3b8; border: none; background: transparent; width: 100%; padding: 12px 0; transition: .2s; }
        .nav-item.active { color: white; }
        .nav-item.active .nav-icon { background: var(--accent-blue); color: white; box-shadow: 0 4px 12px rgba(37,99,235,.4); }
        .nav-icon { width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: .2s; }
        .nav-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; opacity: .8; }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px 16px; border-bottom: 1px solid var(--border); background: white; }
        .sidebar-header h3 { margin: 0; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); }
        .sidebar-body { flex: 1; overflow-y: auto; padding: 12px; }

        /* CHAT LIST ITEMS */
        .chat-item {
            display: flex; align-items: center; gap: 8px; padding: 10px 12px;
            border-radius: 10px; margin-bottom: 6px; cursor: pointer;
            border-left: 3px solid transparent; transition: .2s;
            background: white; border: 1px solid var(--border);
        }
        .chat-item:hover { border-color: var(--accent-blue); background: #eff6ff; }
        .chat-item.active { border-color: var(--accent-blue); background: #eff6ff; border-left: 3px solid var(--accent-blue); }
        .chat-item-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .chat-item-info { flex: 1; min-width: 0; }
        .chat-item-title { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-item-time { font-size: 10px; color: var(--text-secondary); margin-top: 2px; }
        .chat-delete-btn { opacity: 0; background: none; border: none; cursor: pointer; font-size: 14px; padding: 4px; border-radius: 6px; transition: .2s; color: #ef4444; flex-shrink: 0; }
        .chat-item:hover .chat-delete-btn { opacity: 1; }
        .chat-delete-btn:hover { background: #fee2e2; }

        /* NEW CHAT BTN */
        .new-chat-btn { width: 100%; padding: 11px; border: 1.5px dashed var(--accent-blue); border-radius: 10px; background: #eff6ff; color: var(--accent-blue); font-weight: 700; font-size: 13px; cursor: pointer; margin-bottom: 12px; transition: .2s; }
        .new-chat-btn:hover { background: #dbeafe; }

        /* CHAT COLORS â€” cycling palette */
        .dot-0 { background: #2563eb; }
        .dot-1 { background: #7c3aed; }
        .dot-2 { background: #db2777; }
        .dot-3 { background: #ea580c; }
        .dot-4 { background: #16a34a; }
        .dot-5 { background: #0891b2; }

        /* HUB TABS */
        .hub-tabs { display: flex; gap: 4px; margin-bottom: 16px; background: #f1f5f9; padding: 4px; border-radius: 10px; }
        .hub-tab-btn { flex: 1; border: none; padding: 8px; font-size: 11px; font-weight: 700; cursor: pointer; color: var(--text-secondary); border-radius: 8px; background: transparent; transition: .2s; }
        .hub-tab-btn.active { background: white; color: var(--accent-blue); box-shadow: 0 2px 4px rgba(0,0,0,.05); }

        /* NEWS */
        .news-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .refresh-btn { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 5px 10px; font-size: 11px; font-weight: 600; cursor: pointer; color: var(--accent-blue); transition: .2s; }
        .refresh-btn:hover { background: #eff6ff; }
        .news-card { display: block; background: white; border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 8px; text-decoration: none; color: inherit; transition: .2s; }
        .news-card:hover { border-color: var(--accent-blue); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.08); }
        .news-source { font-size: 9px; font-weight: 800; padding: 2px 7px; border-radius: 5px; text-transform: uppercase; margin-bottom: 7px; display: inline-block; color: #d97706; background: #fef3c7; }
        .news-title { font-weight: 700; font-size: 12px; color: var(--text-main); line-height: 1.4; }
        .news-loading { text-align: center; font-size: 12px; color: var(--text-secondary); padding: 20px; }

        /* MEMORY */
        .memory-train { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
        .memory-input { width: 100%; height: 90px; padding: 12px; border: 1px solid var(--border); border-radius: 12px; font-family: inherit; font-size: 13px; resize: none; outline: none; }
        .memory-input:focus { border-color: var(--accent-blue); }
        .memory-card { background: white; border: 1px solid #dbeafe; border-radius: 10px; padding: 12px; margin-bottom: 8px; }
        .memory-tag { font-size: 9px; font-weight: 800; padding: 2px 7px; border-radius: 5px; text-transform: uppercase; margin-bottom: 7px; display: inline-block; color: #2563eb; background: #dbeafe; }
        .memory-text { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }

        /* MAIN CHAT */
        .main-chat { flex: 1; display: flex; flex-direction: column; }

        /* WELCOME */
        .welcome-banner { padding: 24px 10%; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%); }
        .welcome-banner h2 { margin: 0 0 4px 0; font-size: 18px; color: var(--accent-blue); }
        .welcome-banner p { margin: 0; font-size: 13px; color: var(--text-secondary); }

        #chat-window { flex: 1; overflow-y: auto; padding: 24px 10%; display: flex; flex-direction: column; gap: 16px; }
        .message { max-width: 80%; padding: 13px 17px; border-radius: 18px; font-size: 14px; line-height: 1.6; }
        .user { align-self: flex-end; background: var(--accent-blue); color: white; border-bottom-right-radius: 4px; }
        .bot { align-self: flex-start; background: #f1f5f9; border: 1px solid var(--border); border-bottom-left-radius: 4px; }

        .input-area { padding: 16px 10%; border-top: 1px solid var(--border); }
        .input-box { display: flex; gap: 10px; background: #f8fafc; border: 1px solid var(--border); padding: 8px 16px; border-radius: 14px; align-items: center; }
        .input-box input { flex: 1; border: none; background: transparent; outline: none; padding: 8px 0; font-size: 14px; }
        .send-btn { background: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px; transition: .2s; }
        .send-btn:hover { background: #1d4ed8; }

        .btn-save { background: var(--accent-blue); color: white; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px; transition: .2s; width: 100%; }
        .btn-save:hover { background: #1d4ed8; }
    </style>
</head>
<body>

<nav class="global-nav">
    <img src="https://ui-avatars.com/api/?name=N&background=2563eb&color=fff" class="logo-img" alt="Niovi">
    <button class="nav-item active" id="nav-chat" onclick="setTab('chat')">
        <div class="nav-icon">ğŸ’¬</div>
        <div class="nav-label">Chat</div>
    </button>
    <button class="nav-item" id="nav-intel" onclick="setTab('intel')">
        <div class="nav-icon">âš¡</div>
        <div class="nav-label">Intel</div>
    </button>
</nav>

<aside class="sidebar">
    <div class="sidebar-header"><h3 id="drawer-title">Î£Î¥ÎÎŸÎœÎ™Î›Î™Î•Î£</h3></div>
    <div class="sidebar-body" id="drawer-content"></div>
</aside>

<main class="main-chat">
    <div class="welcome-banner">
        <h2>ğŸ‘‹ ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸Î±Ï„Îµ ÏƒÏ„Î· Niovi AI</h2>
        <p>Î£Ï„ÏÎ±Ï„Î·Î³Î¹ÎºÏŒÏ‚ Î²Î¿Î·Î¸ÏŒÏ‚ Î³Î¹Î± Î¤ÎµÏ‡Î½Î¿Î»Î¿Î³Î¯Î±, Î”Î¯ÎºÎ±Î¹Î¿ ÎºÎ±Î¹ Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î± â€” ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Î¼Î­Î½Î¿Ï‚ Î¼Îµ ÎµÎ¾ÎµÎ¹Î´Î¹ÎºÎµÏ…Î¼Î­Î½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.</p>
    </div>
    <div id="chat-window"></div>
    <div class="input-area">
        <div class="input-box">
            <input type="text" id="user-input" placeholder="Î£Ï„ÎµÎ¯Î»Ï„Îµ Î­Î½Î± Î¼Î®Î½Ï…Î¼Î±..." autocomplete="off">
            <button class="send-btn" onclick="handleSend()">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</button>
        </div>
    </div>
</main>

<script>
// ===================== CONFIG =====================
var FIREBASE_CONFIG = {
    apiKey: "AIzaSyC6Cp_zMV3T1eggkjLhLmf1q8RuTv9wogE",
    authDomain: "niovi-ai.firebaseapp.com",
    projectId: "niovi-ai",
    storageBucket: "niovi-ai.firebasestorage.app",
    messagingSenderId: "743828032118",
    appId: "1:743828032118:web:fea3e038104e1c84b86d57"
};
var GEMINI_API_KEY = "AIzaSyBiwqO6mBx3ng0RY58MmBvO2vBA9TZ8jFA";
// Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ v1beta endpoint Î¼Îµ gemini-pro Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿
var GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + GEMINI_API_KEY;
var APP_ID = 'niovi_enterprise_v2';

// ===================== SYSTEM PROMPT (Î•ÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ·) =====================
var NIOVI_SYSTEM_PROMPT = `Î•Î¯ÏƒÎ±Î¹ Î· Niovi AI, Î­Î½Î±Ï‚ ÎµÎ¾ÎµÎ¹Î´Î¹ÎºÎµÏ…Î¼Î­Î½Î¿Ï‚ ÏƒÏ„ÏÎ±Ï„Î·Î³Î¹ÎºÏŒÏ‚ Î²Î¿Î·Î¸ÏŒÏ‚ Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„ÎµÎ¯ Î¼Îµ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎºÎ±Î¹ Ï„Î· Ï†Î¹Î»Î¿ÏƒÎ¿Ï†Î¯Î± Ï„Î·Ï‚ ÎÎ¹ÏŒÎ²Î·Ï‚ Î§ÏÎ¹ÏƒÏ„Î¿Ï€Î¿ÏÎ»Î¿Ï….

Î¤Î‘Î¥Î¤ÎŸÎ¤Î—Î¤Î‘ & Î•ÎÎ•Î™Î”Î™ÎšÎ•Î¥Î£Î—:
- Î•Î¯ÏƒÎ±Î¹ ÎµÎ¹Î´Î¹ÎºÏŒÏ‚ ÏƒÎµ: Î¤ÎµÏ‡Î½Î·Ï„Î® ÎÎ¿Î·Î¼Î¿ÏƒÏÎ½Î· (AI Act, AI ethics, AI geopolitics), Î¨Î·Ï†Î¹Î±ÎºÏŒ Î”Î¯ÎºÎ±Î¹Î¿, Fintech, Cloud, Logistics & ÎÎ±Ï…Ï„Î¹Î»Î¯Î±, Î¨Î·Ï†Î¹Î±ÎºÎ® Î”Î¹Ï€Î»Ï‰Î¼Î±Ï„Î¯Î± ÎºÎ±Î¹ Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±
- Î“Î½Ï‰ÏÎ¯Î¶ÎµÎ¹Ï‚ ÏƒÎµ Î²Î¬Î¸Î¿Ï‚ Ï„Î· ÏƒÏ‡Î­ÏƒÎ· Ï„ÎµÏ‡Î½Î¿Î»Î¿Î³Î¯Î±Ï‚ ÎºÎ±Î¹ Î³ÎµÏ‰Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚, ÎºÎ±Î¹ Ï€ÏÏ‚ Î±Ï…Ï„Î® ÎµÏ€Î·ÏÎµÎ¬Î¶ÎµÎ¹ Ï„Î·Î½ Î•Î»Î»Î¬Î´Î±
- ÎšÎ±Ï„Î±Î½Î¿ÎµÎ¯Ï‚ Ï„Î¿Î½ Î±Ï€ÏŒÎ´Î·Î¼Î¿ Î•Î»Î»Î·Î½Î¹ÏƒÎ¼ÏŒ, Ï„Î¿ Brain Gain ÎºÎ±Î¹ Ï„Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Î•Î»Î»Î¬Î´Î±Ï‚-ÎÎ­Î±Ï‚ Î¥ÏŒÏÎºÎ·Ï‚
- Î•Î¯ÏƒÎ±Î¹ ÎµÎ½Î®Î¼ÎµÏÎ¿Ï‚ Î³Î¹Î± Ï„Î·Î½ ÎµÎ»Î»Î·Î½Î¹ÎºÎ® Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®, Î¿Î¹ÎºÎ¿Î½Î¿Î¼Î¯Î± ÎºÎ±Î¹ ÎºÎ±Î¹Î½Î¿Ï„Î¿Î¼Î¯Î±

Î£Î¤Î¥Î› Î•Î Î™ÎšÎŸÎ™ÎÎ©ÎÎ™Î‘Î£:
- ÎœÎ¹Î»Î¬Ï‚ ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÎ¬ Î±Î»Î»Î¬ ÎºÎ±Ï„Î±Î½Î¿Î·Ï„Î¬ â€” Î±Ï€Î¿Ï†ÎµÏÎ³ÎµÎ¹Ï‚ Ï„Î¿Î½ Î¾ÏÎ»Î¹Î½Î¿ Î»ÏŒÎ³Î¿
- Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï‚ Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Î±Ï€ÏŒ Ï„Î¹Ï‚ Î—Î Î‘ ÎºÎ±Î¹ Ï„Î·Î½ Î•Î»Î»Î¬Î´Î±
- ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÎµÎ¾Î·Î³ÎµÎ¯Ï‚ ÏƒÏÎ½Î¸ÎµÏ„ÎµÏ‚ Î­Î½Î½Î¿Î¹ÎµÏ‚ Î±Ï€Î»Î¬ (ELI5 style)
- Î‘Ï€Î¬Î½Ï„Î± Î Î‘ÎÎ¤Î‘ ÏƒÏ„Î± Î•Î»Î»Î·Î½Î¹ÎºÎ¬ ÎµÎºÏ„ÏŒÏ‚ Î±Î½ Î¶Î·Ï„Î·Î¸ÎµÎ¯ Î±Î»Î»Î¹ÏÏ‚
- Î•Î¯ÏƒÎ±Î¹ ÏƒÏ…Î½Î¿Ï€Ï„Î¹ÎºÏŒÏ‚ ÎºÎ±Î¹ ÏƒÏ„Î¿Ï‡ÎµÏ…Î¼Î­Î½Î¿Ï‚ â€” Î´ÎµÎ½ ÎºÎ¬Î½ÎµÎ¹Ï‚ padding

Î˜Î•ÎœÎ‘Î¤Î™ÎšÎ•Î£ Î Î•Î¡Î™ÎŸÎ§Î•Î£:
1. AI & Î¤ÎµÏ‡Î½Î¿Î»Î¿Î³Î¯Î±: AI Act Î•Ï…ÏÏÏ€Î·Ï‚, Î±Î»Î³ÏŒÏÎ¹Î¸Î¼Î¿Î¹, ÏˆÎ·Ï†Î¹Î±ÎºÎ¬ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î±, ÎºÏ…Î²ÎµÏÎ½Î¿Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±
2. Fintech & ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¯Î±: ÏˆÎ·Ï†Î¹Î±ÎºÎ­Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚, blockchain, ÎµÏ…ÎºÎ±Î¹ÏÎ¯ÎµÏ‚ Î³Î¹Î± ÎµÎ»Î»Î·Î½Î¹ÎºÎ­Ï‚ ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÎ®ÏƒÎµÎ¹Ï‚
3. Î“ÎµÏ‰Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® Î¤ÎµÏ‡Î½Î¿Î»Î¿Î³Î¯Î±Ï‚: data sovereignty, ÏˆÎ·Ï†Î¹Î±ÎºÎ® Î¬Î¼Ï…Î½Î±, Î¸Î­ÏƒÎ· Î•Î»Î»Î¬Î´Î±Ï‚ ÏƒÏ„Î¿ Ï€Î±Î³ÎºÏŒÏƒÎ¼Î¹Î¿ Ï„ÎµÏ‡Î½Î¿Î»Î¿Î³Î¹ÎºÏŒ Ï‡Î¬ÏÏ„Î·
4. Logistics & ÎÎ±Ï…Ï„Î¹Î»Î¯Î±: Î•Î»Î»Î¬Î´Î± Ï‰Ï‚ logistics hub, Î£Î¿Ï…Î­Î¶, Ï„ÎµÏ‡Î½Î¿Î»Î¿Î³Î¯Î± ÏƒÏ„Î· Î½Î±Ï…Ï„Î¹Î»Î¯Î±
5. Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±: startups, ÎµÏ€ÎµÎ½Î´ÏÏƒÎµÎ¹Ï‚, ÏƒÏÎ½Î´ÎµÏƒÎ· Î­ÏÎµÏ…Î½Î±Ï‚ Î¼Îµ Î±Î³Î¿ÏÎ¬, REBRAIN Greece
6. Î Î¿Î»Î¹Ï„Î¹ÎºÎ® & ÎšÎ¿Î¹Î½Ï‰Î½Î¯Î±: Î±Ï€ÏŒÎ´Î·Î¼Î¿Î¹, ÏˆÎ®Ï†Î¿Ï‚ Î±Ï€Î¿Î´Î®Î¼Ï‰Î½, Î´Î·Î¼ÏŒÏƒÎ¹Î¿Ï‚ Î´Î¹Î¬Î»Î¿Î³Î¿Ï‚ Î³Î¹Î± Ï„ÎµÏ‡Î½Î¿Î»Î¿Î³Î¯Î±`;

// ===================== STATE =====================
var user = null;
var currentChatId = null;
var currentTab = 'chat';
var hubSubTab = 'news';
var localIntel = [];
var chatListUnsubscribe = null;
var newsCache = null;
var db, auth;
var chatColors = ['dot-0','dot-1','dot-2','dot-3','dot-4','dot-5'];
var colorIndex = 0;

// ===================== FIREBASE INIT =====================
firebase.initializeApp(FIREBASE_CONFIG);
auth = firebase.auth();
db = firebase.firestore();

auth.onAuthStateChanged(function(u) {
    user = u;
    if (u) {
        setupKnowledgeListener();
        syncSidebar();
        if (!currentChatId) createNewChat();
    }
});
auth.signInAnonymously().catch(function(e){ console.error("Auth:", e); });

// ===================== NAVIGATION =====================
function setTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.nav-item').forEach(function(i){ i.classList.remove('active'); });
    document.getElementById('nav-' + tab).classList.add('active');
    syncSidebar();
}
function setHubSubTab(sub) {
    hubSubTab = sub;
    syncSidebar();
}

// ===================== SIDEBAR =====================
function syncSidebar() {
    var title = document.getElementById('drawer-title');
    var content = document.getElementById('drawer-content');
    if (currentTab === 'chat') {
        title.innerText = 'Î£Î¥ÎÎŸÎœÎ™Î›Î™Î•Î£';
        content.innerHTML = '<button class="new-chat-btn" onclick="createNewChat()">ï¼‹ ÎÎ­Î± Î£Ï…Î½Î¿Î¼Î¹Î»Î¯Î±</button><div id="chat-list"></div>';
        renderChatList();
    } else {
        title.innerText = 'INTELLIGENCE HUB';
        content.innerHTML =
            '<div class="hub-tabs">' +
                '<button class="hub-tab-btn ' + (hubSubTab==='news'?'active':'') + '" onclick="setHubSubTab(\'news\')">ğŸ“° News Feed</button>' +
                '<button class="hub-tab-btn ' + (hubSubTab==='memory'?'active':'') + '" onclick="setHubSubTab(\'memory\')">ğŸ§  Memory</button>' +
            '</div>' +
            '<div id="hub-container"></div>';
        renderHubContent();
    }
}

// ===================== CHAT LIST =====================
function renderChatList() {
    if (chatListUnsubscribe) chatListUnsubscribe();
    chatListUnsubscribe = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('sessions')
        .onSnapshot(function(snap) {
            var list = document.getElementById('chat-list');
            if (!list) return;
            var sessions = [];
            snap.forEach(function(d){ var data = d.data(); data._id = d.id; sessions.push(data); });
            sessions.sort(function(a,b){ return new Date(b.timestamp)-new Date(a.timestamp); });
            list.innerHTML = '';
            sessions.forEach(function(data, idx) {
                var colorClass = chatColors[idx % chatColors.length];
                var isActive = data._id === currentChatId;
                var timeStr = data.timestamp ? new Date(data.timestamp).toLocaleTimeString('el-GR',{hour:'2-digit',minute:'2-digit'}) : '';
                var div = document.createElement('div');
                div.className = 'chat-item' + (isActive ? ' active' : '');
                div.id = 'chat-row-' + data._id;
                div.innerHTML =
                    '<div class="chat-item-dot ' + colorClass + '"></div>' +
                    '<div class="chat-item-info">' +
                        '<div class="chat-item-title">' + (data.title || 'Î£Ï…Î½Î¿Î¼Î¹Î»Î¯Î±') + '</div>' +
                        '<div class="chat-item-time">' + timeStr + '</div>' +
                    '</div>' +
                    '<button class="chat-delete-btn" onclick="deleteChat(event,\'' + data._id + '\')" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®">ğŸ—‘ï¸</button>';
                div.querySelector('.chat-item-info').onclick = (function(id){ return function(){ loadChatById(id); }; })(data._id);
                list.appendChild(div);
            });
        }, function(err){ console.error("Chat list:", err); });
}

function deleteChat(e, id) {
    e.preventDefault(); e.stopPropagation();
    if (!confirm('ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î· ÏƒÏ…Î½Î¿Î¼Î¹Î»Î¯Î±;')) return;
    var row = document.getElementById('chat-row-' + id);
    if (row) row.style.opacity = '0.3';
    db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('sessions').doc(id)
        .delete()
        .then(function(){
            if (currentChatId === id) { currentChatId = null; createNewChat(); }
        })
        .catch(function(e){ console.error("Delete:", e); alert('Î£Ï†Î¬Î»Î¼Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚.'); });
}

// ===================== NEW CHAT =====================
function createNewChat() {
    var id = 'chat_' + Date.now();
    currentChatId = id;
    document.getElementById('chat-window').innerHTML = '';
    db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('sessions').doc(id)
        .set({ title: 'Î‘Î½Î¬Î»Ï…ÏƒÎ· ' + new Date().toLocaleTimeString('el-GR',{hour:'2-digit',minute:'2-digit'}), timestamp: new Date().toISOString() })
        .then(function(){
            appendMessage('Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! Î•Î¯Î¼Î±Î¹ Î· **Niovi AI**. ÎœÏ€Î¿ÏÏ Î½Î± ÏƒÎ±Ï‚ Î²Î¿Î·Î¸Î®ÏƒÏ‰ Î¼Îµ Î¸Î­Î¼Î±Ï„Î± Î¤ÎµÏ‡Î½Î¿Î»Î¿Î³Î¯Î±Ï‚, AI, Î”Î¹ÎºÎ±Î¯Î¿Ï…, Fintech, Î“ÎµÏ‰Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ®Ï‚ ÎºÎ±Î¹ Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±Ï‚. Î¤Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± ÎµÎ¾ÎµÏÎµÏ…Î½Î®ÏƒÎ¿Ï…Î¼Îµ ÏƒÎ®Î¼ÎµÏÎ±;', 'bot');
        })
        .catch(function(e){ console.error("New chat:", e); });
}

// ===================== LOAD CHAT =====================
function loadChatById(id) {
    currentChatId = id;
    var win = document.getElementById('chat-window');
    win.innerHTML = '';
    // Update active state in list
    document.querySelectorAll('.chat-item').forEach(function(el){ el.classList.remove('active'); });
    var row = document.getElementById('chat-row-' + id);
    if (row) row.classList.add('active');

    db.collection('artifacts').doc(APP_ID).collection('public').doc('data')
        .collection('messages').doc(id).collection('logs')
        .get().then(function(snap){
            var msgs = [];
            snap.forEach(function(m){ msgs.push(m.data()); });
            msgs.sort(function(a,b){ return new Date(a.timestamp)-new Date(b.timestamp); });
            if (msgs.length === 0) {
                appendMessage('Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! Î•Î¯Î¼Î±Î¹ Î· **Niovi AI**. Î ÏÏ‚ Î¼Ï€Î¿ÏÏ Î½Î± ÏƒÎ±Ï‚ Î²Î¿Î·Î¸Î®ÏƒÏ‰;', 'bot');
            } else {
                msgs.forEach(function(m){ appendMessage(m.text, m.role); });
            }
        }).catch(function(e){ console.error("Load chat:", e); });
}

// ===================== HUB CONTENT =====================
function renderHubContent() {
    var container = document.getElementById('hub-container');
    if (!container) return;
    if (hubSubTab === 'news') {
        container.innerHTML =
            '<div class="news-header">' +
                '<span style="font-size:11px; font-weight:700; color:var(--text-secondary);">Î¤Î•Î›Î•Î¥Î¤Î‘Î™Î‘ ÎÎ•Î‘</span>' +
                '<button class="refresh-btn" onclick="fetchNews()">ğŸ”„ Refresh</button>' +
            '</div>' +
            '<div id="news-container"></div>';
        if (newsCache) {
            document.getElementById('news-container').innerHTML = newsCache;
        } else {
            fetchNews();
        }
    } else {
        container.innerHTML =
            '<div class="memory-train">' +
                '<textarea id="mem-input" class="memory-input" placeholder="Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„ÏÎ±Ï„Î·Î³Î¹ÎºÎ®Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯Î±Ï‚ Î³Î¹Î± ÎµÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ·..."></textarea>' +
                '<button class="btn-save" onclick="saveToMemory()">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>' +
            '</div>' +
            '<div id="memory-list"></div>';
        renderMemoryList();
    }
}

// ===================== NEWS FEED =====================
async function fetchNews() {
    var container = document.getElementById('news-container');
    if (!container) return;
    container.innerHTML = '<div class="news-loading">ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¬ÏÎ¸ÏÏ‰Î½...</div>';

    // Î˜Î­Î¼Î±Ï„Î± ÏƒÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ Ï„Î¿ Ï€ÏÎ¿Ï†Î¯Î» ÎÎ¹ÏŒÎ²Î·Ï‚ Î§ÏÎ¹ÏƒÏ„Î¿Ï€Î¿ÏÎ»Î¿Ï…
    var newsPrompt = 'Search for 4 very recent real news articles (last 7 days) about these specific topics: AI Act EU regulations, Fintech Greece, digital sovereignty geopolitics, logistics shipping technology, Greek diaspora brain gain, AI technology law. For each article find the real URL. Return ONLY a raw JSON array with NO markdown, NO backticks, NO explanation: [{"title":"...","url":"https://...","source":"...","topic":"AI/Fintech/Geopolitics/Logistics"}]';

    try {
        var response = await fetch(GEMINI_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: newsPrompt }] }]
            })
        });
        var data = await response.json();
        if (!response.ok) throw new Error((data.error && data.error.message) || 'API ' + response.status);

        var raw = (data.candidates && data.candidates[0].content.parts[0].text) || '[]';
        raw = raw.replace(/```json/g,'').replace(/```/g,'').trim();
        var articles = JSON.parse(raw);
        if (!Array.isArray(articles) || articles.length === 0) throw new Error('No articles');

        newsCache = articles.map(function(a) {
            var hostname = a.url;
            try { hostname = new URL(a.url).hostname.replace('www.',''); } catch(e){}
            return '<a href="' + a.url + '" target="_blank" rel="noopener" class="news-card">' +
                '<span class="news-source">' + (a.source || hostname) + '</span>' +
                '<div class="news-title">' + a.title + '</div>' +
                '</a>';
        }).join('');
        container.innerHTML = newsCache;
    } catch(e) {
        console.error('fetchNews:', e);
        // Fallback static news Î±Î½ Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹ Ï„Î¿ API
        container.innerHTML = [
            {title:'EU AI Act: Î¤Î¹ Î±Î»Î»Î¬Î¶ÎµÎ¹ Î³Î¹Î± Ï„Î¹Ï‚ ÎµÎ»Î»Î·Î½Î¹ÎºÎ­Ï‚ ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÎ®ÏƒÎµÎ¹Ï‚', url:'https://ec.europa.eu/digital-single-market/en/artificial-intelligence', source:'European Commission'},
            {title:'Î¨Î·Ï†Î¹Î±ÎºÎ® Î”Î¹Ï€Î»Ï‰Î¼Î±Ï„Î¯Î±: Î— Î½Î­Î± Î³ÎµÏ‰Ï€Î¿Î»Î¹Ï„Î¹ÎºÎ® Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½', url:'https://www.weforum.org/agenda/2024/01/digital-diplomacy-geopolitics/', source:'World Economic Forum'},
            {title:'Fintech ÏƒÏ„Î·Î½ Î•Î»Î»Î¬Î´Î±: Î•Ï…ÎºÎ±Î¹ÏÎ¯ÎµÏ‚ ÎºÎ±Î¹ Ï€ÏÎ¿ÎºÎ»Î®ÏƒÎµÎ¹Ï‚ 2025', url:'https://www.kathimerini.gr', source:'ÎšÎ±Î¸Î·Î¼ÎµÏÎ¹Î½Î®'},
            {title:'REBRAIN Greece: Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® Ï„Î±Î»Î­Î½Ï„Ï‰Î½ Î±Ï€ÏŒ Ï„Î¿ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒ', url:'https://rebrain.gov.gr', source:'REBRAIN Greece'}
        ].map(function(a){
            return '<a href="' + a.url + '" target="_blank" rel="noopener" class="news-card">' +
                '<span class="news-source">' + a.source + '</span>' +
                '<div class="news-title">' + a.title + '</div>' +
                '</a>';
        }).join('');
    }
}

// ===================== MEMORY =====================
function renderMemoryList() {
    var list = document.getElementById('memory-list');
    if (!list) return;
    if (localIntel.length === 0) {
        list.innerHTML = '<p style="font-size:12px; text-align:center; color:#94a3b8; margin-top:16px;">ÎšÎµÎ½Î® Î¼Î½Î®Î¼Î·. Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎµÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ·Ï‚.</p>';
        return;
    }
    list.innerHTML = localIntel.map(function(m){
        return '<div class="memory-card"><span class="memory-tag">DATA</span><div class="memory-text">' + m.text + '</div></div>';
    }).join('');
}

function saveToMemory() {
    var input = document.getElementById('mem-input');
    var text = input.value.trim();
    if (!text || !user) return;
    db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('knowledge')
        .add({ text: text, timestamp: new Date().toISOString(), userId: user.uid })
        .then(function(){ input.value = ''; })
        .catch(function(e){ console.error('saveToMemory:', e); });
}

function setupKnowledgeListener() {
    db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('knowledge')
        .onSnapshot(function(snap){
            localIntel = [];
            snap.forEach(function(d){ localIntel.push(d.data()); });
            if (currentTab === 'intel' && hubSubTab === 'memory') renderMemoryList();
        }, function(e){ console.error('Knowledge:', e); });
}

// ===================== SEND MESSAGE =====================
async function handleSend() {
    var input = document.getElementById('user-input');
    var text = input.value.trim();
    if (!text || !user || !currentChatId) return;

    appendMessage(text, 'user');
    input.value = '';
    var currentId = currentChatId;

    // Save user message
    db.collection('artifacts').doc(APP_ID).collection('public').doc('data')
        .collection('messages').doc(currentId).collection('logs')
        .add({ text: text, role: 'user', timestamp: new Date().toISOString() });

    // Loading
    var loadingDiv = document.createElement('div');
    loadingDiv.className = 'message bot';
    loadingDiv.id = 'loading-msg';
    loadingDiv.innerHTML = '<i>â³ Î£ÎºÎ­Ï†Ï„Î¿Î¼Î±Î¹...</i>';
    document.getElementById('chat-window').appendChild(loadingDiv);
    document.getElementById('chat-window').scrollTop = 99999;

    try {
        var memText = localIntel.map(function(i){ return i.text; }).join(' | ');
        var fullPrompt = NIOVI_SYSTEM_PROMPT +
            (memText ? '\n\nÎ•Î Î™Î Î›Î•ÎŸÎ Î”Î•Î”ÎŸÎœÎ•ÎÎ‘ ÎœÎÎ—ÎœÎ—Î£:\n' + memText : '') +
            '\n\nÎ•Î¡Î©Î¤Î—Î£Î— Î§Î¡Î—Î£Î¤Î—: ' + text;

        var response = await fetch(GEMINI_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: fullPrompt }] }]
            })
        });

        var data = await response.json();

        if (!response.ok) {
            var errMsg = (data.error && data.error.message) ? data.error.message : 'HTTP ' + response.status;
            throw new Error(errMsg);
        }

        var reply = (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0].text)
            || 'Î”ÎµÎ½ Î­Î»Î±Î²Î± Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.';

        var loading = document.getElementById('loading-msg');
        if (loading) loading.remove();
        appendMessage(reply, 'bot');

        // Save bot reply
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data')
            .collection('messages').doc(currentId).collection('logs')
            .add({ text: reply, role: 'bot', timestamp: new Date().toISOString() });

    } catch(e) {
        console.error('handleSend:', e);
        var loading = document.getElementById('loading-msg');
        if (loading) loading.remove();
        appendMessage('âš ï¸ ' + e.message, 'bot');
    }
}

// ===================== APPEND MESSAGE =====================
function appendMessage(text, role) {
    var win = document.getElementById('chat-window');
    if (!win) return;
    var div = document.createElement('div');
    div.className = 'message ' + role;
    div.innerHTML = text
        .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
        .replace(/\*(.*?)\*/g,'<i>$1</i>')
        .replace(/\n/g,'<br>');
    win.appendChild(div);
    win.scrollTop = win.scrollHeight;
}

document.getElementById('user-input').addEventListener('keypress', function(e){
    if (e.key === 'Enter') handleSend();
});
</script>
</body>
</html>

