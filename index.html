<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niovi AI - Strategic Intelligence Hub</title>
    <style>
        :root {
            --bg-sidebar: #f8fafc; 
            --bg-chat: #ffffff;
            --text-main: #0f172a;
            --text-secondary: #64748b;
            --accent-blue: #2563eb;
            --accent-red: #ef4444; 
            --accent-dark: #1e3a8a;
            --border: #e2e8f0;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.8);
        }

        body { 
            font-family: 'Inter', -apple-system, system-ui, sans-serif; 
            background-color: var(--bg-chat); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            color: var(--text-main); 
            overflow: hidden;
        }

        /* Sidebar Styling */
        .sidebar { 
            width: 420px; 
            background-color: var(--bg-sidebar); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            padding: 24px; 
            box-sizing: border-box; 
            overflow-y: auto;
        }
        
        .profile-section { text-align: center; margin-bottom: 25px; }
        .profile-frame { 
            width: 65px; height: 65px; border-radius: 18px; overflow: hidden; 
            margin: 0 auto 12px; border: 2.5px solid var(--accent-blue);
            padding: 2px; background: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }
        .profile-frame img { width: 100%; height: 100%; object-fit: cover; border-radius: 14px; }
        .persona-name { font-size: 18px; font-weight: 800; color: var(--accent-dark); margin: 0; letter-spacing: -0.5px; }
        .persona-title { font-size: 11px; color: var(--text-secondary); margin-top: 4px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; }

        /* Widget Headers */
        .widget-header { 
            display: flex; justify-content: space-between; align-items: center;
            margin: 30px 0 15px 0; 
        }
        .widget-title { font-size: 11px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .refresh-btn { font-size: 10px; cursor: pointer; color: var(--accent-blue); font-weight: 800; text-decoration: none; border: 1px solid #dbeafe; padding: 4px 10px; border-radius: 6px; background: #eff6ff; }

        /* Search Container */
        .search-container {
            background: white; border: 1px solid var(--border); border-radius: 14px;
            padding: 10px 14px; margin-bottom: 20px; display: flex; gap: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
        }
        .search-container input { border: none; font-size: 13px; flex: 1; outline: none; background: transparent; font-weight: 500; }
        .search-btn {
            background: var(--accent-blue); color: white; border: none;
            width: 32px; height: 32px; border-radius: 10px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* Intelligence Feed Items - Based on Screenshots */
        .news-card {
            background: white; border: 1px solid var(--border); border-radius: 16px;
            padding: 16px; margin-bottom: 12px; transition: all 0.3s ease;
            text-decoration: none; color: inherit; display: block;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        .news-card:hover { transform: translateY(-2px); border-color: var(--accent-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .news-meta { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
        .meta-category { font-size: 10px; font-weight: 800; color: var(--accent-blue); text-transform: uppercase; }
        .meta-date { font-size: 10px; color: var(--text-secondary); font-weight: 600; }
        .meta-source { font-size: 10px; font-weight: 800; color: var(--accent-red); text-transform: uppercase; }

        .news-headline { font-size: 14px; font-weight: 700; line-height: 1.5; color: var(--text-main); margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Strategic Hub Controls */
        .hub-panel { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
        .hub-input { width: 100%; border: 1px solid var(--border); border-radius: 10px; height: 100px; font-size: 12px; padding: 12px; resize: none; box-sizing: border-box; font-family: inherit; margin-bottom: 10px; }
        .hub-btn { width: 100%; background: var(--accent-blue); color: white; border: none; padding: 12px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .hub-btn:hover { background: var(--accent-dark); }
        .hub-status { font-size: 10px; margin-top: 10px; text-align: center; color: var(--text-secondary); font-weight: 600; }

        /* Chat Window */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: var(--white); }
        #chat-window { flex: 1; overflow-y: auto; padding: 50px 15%; display: flex; flex-direction: column; gap: 28px; }
        
        .message { max-width: 80%; padding: 18px 24px; font-size: 15px; line-height: 1.7; border-radius: 24px; animation: fadeIn 0.4s ease; position: relative; }
        .user { align-self: flex-end; background: var(--accent-blue); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2); }
        .bot { align-self: flex-start; background: #f1f5f9; color: #1e293b; border-bottom-left-radius: 4px; border: 1px solid #e2e8f0; }
        
        .strategy-badge { position: absolute; top: -18px; left: 12px; font-size: 9px; font-weight: 900; color: var(--accent-blue); text-transform: uppercase; background: white; padding: 3px 10px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Input Bar */
        .input-area { padding: 30px 15% 45px; background: white; }
        .input-box { display: flex; gap: 15px; background: #f8fafc; padding: 14px 25px; border-radius: 50px; border: 1px solid var(--border); transition: 0.3s; }
        .input-box:focus-within { border-color: var(--accent-blue); background: white; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.05); }
        .input-box input { flex: 1; border: none; background: transparent; outline: none; font-size: 15px; font-weight: 500; }
        .send-trigger { background: var(--accent-blue); color: white; border: none; padding: 10px 25px; border-radius: 30px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .send-trigger:hover { transform: scale(1.05); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="profile-section">
        <div class="profile-frame">
            <img src="https://ui-avatars.com/api/?name=Niovi+AI&background=2563eb&color=fff&bold=true" alt="Niovi AI">
        </div>
        <h1 class="persona-name">NioviAI</h1>
        <div class="persona-title">Strategic Marketing Hub</div>
    </div>

    <div class="widget-header">
        <div class="widget-title">Strategic Deep Search</div>
    </div>
    <div class="search-container">
        <input type="text" id="news-search-input" placeholder="Αναζήτηση (π.χ. EU AI Act)...">
        <button class="search-btn" onclick="searchStrategicNews()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>
    </div>
    
    <div class="widget-header">
        <div class="widget-title">Intelligence Feed</div>
        <span class="refresh-btn" onclick="fetchLiveNews()">Refresh</span>
    </div>
    <div id="news-loader" class="loading-pulse" style="display:none; text-align:center; font-size:11px; color:var(--accent-blue); padding:10px;">Scanning Global Sources...</div>
    <div id="intelligence-feed"></div>

    <div class="widget-header">
        <div class="widget-title">Strategic Knowledge Hub</div>
    </div>
    <div class="hub-panel">
        <div id="cloud-status" style="font-size: 9px; color: var(--text-secondary); margin-bottom: 8px; font-weight: bold;">Firebase: Connecting...</div>
        <textarea id="hub-input" class="hub-input" placeholder="Προσθήκη στρατηγικής γνώσης (π.χ. λεπτομέρειες για projects, hooks, νομικά updates)..."></textarea>
        <button class="hub-btn" onclick="syncKnowledge()">Update Strategic Memory</button>
        <div id="memory-stats" class="hub-status">0 Strategic Nodes Connected</div>
    </div>
</div>

<div class="main-chat">
    <div id="chat-window"></div>
    <div class="input-area">
        <div class="input-box">
            <input type="text" id="user-input" placeholder="Ζητήστε ανάλυση, Content Hooks ή στρατηγικό πλάνο...">
            <button class="send-trigger" onclick="handleChat()">Send</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Production Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyC6Cp_zMV3T1eggkjLhLmf1q8RuTv9wogE",
        authDomain: "niovi-ai.firebaseapp.com",
        projectId: "niovi-ai",
        storageBucket: "niovi-ai.firebasestorage.app",
        messagingSenderId: "743828032118",
        appId: "1:743828032118:web:fea3e038104e1c84b86d57"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const APP_ID = "niovi-strategic-final-v1"; // Fixed App ID for deployment

    let userInstance = null;
    let globalKnowledgeContext = "";

    // Auth & Firebase Sync
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            await signInAnonymously(auth);
        } else {
            userInstance = user;
            document.getElementById('cloud-status').innerText = "Cloud Sync: Active (Firestore Connected)";
            startMemorySync();
        }
    });

    function startMemorySync() {
        // Path matches required public structure for current rules
        const q = collection(db, 'artifacts', APP_ID, 'public', 'data', 'knowledge_hub');
        onSnapshot(q, (snapshot) => {
            let context = "";
            let count = 0;
            snapshot.forEach(doc => {
                context += "\n- " + doc.data().text;
                count++;
            });
            globalKnowledgeContext = context;
            document.getElementById('memory-stats').innerText = `${count} Strategic Nodes Connected`;
        }, (err) => {
            console.error(err);
            document.getElementById('cloud-status').innerText = "Cloud Sync: Error (Check Rules)";
        });
    }

    window.syncKnowledge = async function() {
        const val = document.getElementById('hub-input').value.trim();
        if (!val || !userInstance) return;

        try {
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'knowledge_hub'), {
                text: val,
                timestamp: new Date().toISOString(),
                uid: userInstance.uid
            });
            document.getElementById('hub-input').value = "";
            appendMessage("Strategic Hub Updated. Knowledge synced to Cloud.", 'bot');
        } catch (e) {
            appendMessage("Sync failed. Check Firebase settings.", 'bot');
        }
    }

    // AI & Search Logic
    const GEMINI_KEY = ""; // Replace with your key
    const MODEL_ID = "gemini-2.5-flash-preview-09-2025";

    window.handleChat = async function() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        appendMessage(text, 'user');
        input.value = "";

        const systemPrompt = `
            Persona: NioviAI - Professional Strategic Marketing Advisor.
            Niovi Christopoulou is an Attorney/Expert in AI Law, Tech Policy, and NYC/Athens Business.
            Strategic Context (Knowledge Hub): ${globalKnowledgeContext}
            
            RULES:
            1. Be very direct and professional (concise). 
            2. Use the Strategic Hub data as your internal logic, do not mention "database" or "hub" to the user.
            3. If user asks for Hooks, provide 3 punchy options.
            4. Only provide deep analysis if explicitly requested.
            Answer in Greek unless the user asks otherwise.
        `;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${GEMINI_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: systemPrompt + "\nUser Input: " + text }] }],
                    tools: [{ "google_search": {} }]
                })
            });
            const data = await res.json();
            const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Δεν μπόρεσα να επεξεργαστώ το αίτημα αυτή τη στιγμή.";
            appendMessage(reply, 'bot');
        } catch (e) {
            appendMessage("Connection error with Gemini API.", 'bot');
        }
    };

    function appendMessage(text, type) {
        const win = document.getElementById('chat-window');
        const div = document.createElement('div');
        div.className = `message ${type}`;
        if (type === 'bot') div.innerHTML = `<div class="strategy-badge">Niovi Strategy</div>`;
        div.innerHTML += text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    // Intelligence Feed
    window.fetchLiveNews = async function(queryStr = null) {
        const feed = document.getElementById('intelligence-feed');
        const loader = document.getElementById('news-loader');
        loader.style.display = "block";
        feed.innerHTML = "";

        const finalQuery = queryStr || "EU AI Act current news legal, Niovi Christopoulou tech business Athens NYC, 2024 Artificial Intelligence regulation updates, marketing technology advisors trends";

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${GEMINI_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ parts: [{ text: `Search for news: "${finalQuery}". Return a JSON array of 5 objects: {title, url, source, date, category}. Ensure category is specific (e.g. AI LAW, PROFILE). JSON ONLY.` }] }], 
                    tools: [{ "google_search": {} }] 
                })
            });
            const data = await res.json();
            const raw = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            const match = raw.match(/\[\s*\{.*\}\s*\]/s);
            if (match) {
                const news = JSON.parse(match[0]);
                loader.style.display = "none";
                feed.innerHTML = news.map(n => `
                    <a href="${n.url}" target="_blank" class="news-card">
                        <div class="news-meta">
                            <span class="meta-category">${n.category || 'NEWS'}</span>
                            <span class="meta-date">${n.date || ''}</span>
                            <span class="meta-source">${n.source || 'GLOBAL'}</span>
                        </div>
                        <div class="news-headline">${n.title}</div>
                    </a>
                `).join('');
            }
        } catch (e) {
            loader.innerText = "Error fetching intelligence. Check API Key.";
        }
    }

    window.searchStrategicNews = () => {
        const q = document.getElementById('news-search-input').value;
        fetchLiveNews(q);
    };

    window.onload = () => {
        appendMessage("NioviAI Online. Έτοιμη για στρατηγική υποστήριξη.", 'bot');
        fetchLiveNews();
    };
</script>
</body>
</html>
