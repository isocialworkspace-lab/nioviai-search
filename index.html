<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niovi AI - Strategic Workspace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- âœ… FIX 1: Firebase Compat CDN â€” Ï‡Ï‰ÏÎ¯Ï‚ type="module", ÏŒÎ»ÎµÏ‚ Î¿Î¹ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ ÎµÎ¯Î½Î±Î¹ global -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-nav: #0f172a;
            --bg-sidebar: #f8fafc; 
            --bg-chat: #ffffff;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --accent-blue: #2563eb;
            --border: #e2e8f0;
            --sidebar-width: 320px;
            --nav-width: 80px;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            color: var(--text-main); 
            background: var(--bg-chat);
            overflow: hidden;
        }

        .global-nav {
            width: var(--nav-width);
            background: var(--bg-nav);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
            gap: 24px;
            flex-shrink: 0;
            z-index: 50;
        }

        .logo-img {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #94a3b8;
            border: none;
            background: transparent;
            width: 100%;
            padding: 12px 0;
            transition: all 0.2s;
        }

        .nav-item.active { color: white; }
        .nav-item.active .nav-icon { background: var(--accent-blue); color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
        
        .nav-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: 0.2s;
        }
        .nav-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; }

        .sidebar-drawer {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .drawer-header { padding: 24px 20px; border-bottom: 1px solid var(--border); background: white; }
        .drawer-content { flex: 1; overflow-y: auto; padding: 16px; }

        .history-item {
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
        }
        .history-item:hover { background: #f1f5f9; }
        .history-item.active { background: #eff6ff; color: var(--accent-blue); }

        .hub-tabs { display: flex; gap: 4px; margin-bottom: 20px; background: #f1f5f9; padding: 4px; border-radius: 10px; }
        .hub-tab-btn { flex: 1; border: none; padding: 8px; font-size: 11px; font-weight: 700; cursor: pointer; color: var(--text-secondary); border-radius: 8px; background: transparent; transition: 0.2s; }
        .hub-tab-btn.active { background: white; color: var(--accent-blue); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .memory-train { margin-bottom: 24px; display: flex; flex-direction: column; gap: 10px; }
        .memory-input { 
            width: 100%; height: 100px; padding: 12px; border: 1px solid var(--border); 
            border-radius: 12px; font-family: inherit; font-size: 13px; resize: none; outline: none;
            box-sizing: border-box;
        }
        .memory-input:focus { border-color: var(--accent-blue); }

        .card { 
            background: white; border: 1px solid var(--border); border-radius: 12px; 
            padding: 14px; margin-bottom: 10px; transition: 0.2s;
        }
        .tag { font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; margin-bottom: 8px; display: inline-block; }
        .tag-news { color: #d97706; background: #fef3c7; }
        .tag-memory { color: #2563eb; background: #dbeafe; }
        
        .card-title { font-weight: 700; font-size: 13px; margin: 0 0 6px 0; color: var(--text-main); }
        .card-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }

        .main-chat { flex: 1; display: flex; flex-direction: column; background: white; position: relative; }
        #chat-window { flex: 1; overflow-y: auto; padding: 40px 10%; display: flex; flex-direction: column; gap: 20px; }
        
        .message { max-width: 80%; padding: 14px 18px; border-radius: 18px; font-size: 14px; line-height: 1.5; }
        .user { align-self: flex-end; background: var(--accent-blue); color: white; border-bottom-right-radius: 4px; }
        .bot { align-self: flex-start; background: #f1f5f9; color: var(--text-main); border: 1px solid var(--border); border-bottom-left-radius: 4px; }

        .input-area { padding: 20px 10%; border-top: 1px solid var(--border); }
        .input-box { display: flex; gap: 10px; background: #f8fafc; border: 1px solid var(--border); padding: 8px 16px; border-radius: 14px; align-items: center; }
        .input-box input { flex: 1; border: none; background: transparent; outline: none; padding: 8px 0; font-size: 14px; }

        .btn-action { 
            background: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 10px; 
            cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 13px;
        }
        .btn-action:hover { background: #1d4ed8; }

        .new-chat-btn {
            width: 100%; padding: 12px; border: 1px dashed var(--accent-blue); border-radius: 10px;
            background: #eff6ff; color: var(--accent-blue); font-weight: 600; cursor: pointer;
            margin-bottom: 20px; transition: 0.2s;
        }

        .loading-msg { font-style: italic; opacity: 0.6; }
    </style>
</head>
<body>

<nav class="global-nav">
    <img src="https://ui-avatars.com/api/?name=N&background=2563eb&color=fff" class="logo-img" alt="Niovi">
    <button class="nav-item active" id="nav-chat" onclick="setTab('chat')">
        <div class="nav-icon">ğŸ’¬</div>
        <div class="nav-label">Chat</div>
    </button>
    <button class="nav-item" id="nav-intel" onclick="setTab('intel')">
        <div class="nav-icon">âš¡</div>
        <div class="nav-label">Intel</div>
    </button>
</nav>

<aside class="sidebar-drawer">
    <div class="drawer-header">
        <h3 id="drawer-title" style="margin:0; font-size:11px; text-transform:uppercase; letter-spacing:1px; color:var(--text-secondary);">Î£Î¥ÎÎŸÎœÎ™Î›Î™Î•Î£</h3>
    </div>
    <div class="drawer-content" id="drawer-content"></div>
</aside>

<main class="main-chat">
    <div id="chat-window"></div>
    <div class="input-area">
        <div class="input-box">
            <input type="text" id="user-input" placeholder="Î£Ï„ÎµÎ¯Î»Ï„Îµ Î­Î½Î± Î¼Î®Î½Ï…Î¼Î±..." autocomplete="off">
            <button class="btn-action" onclick="handleSend()">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</button>
        </div>
    </div>
</main>

<!-- âœ… FIX 1: ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒ script â€” Ï‡Ï‰ÏÎ¯Ï‚ type="module" -->
<script>
    // ===================== CONFIG =====================
    var FIREBASE_CONFIG = {
        apiKey: "AIzaSyC6Cp_zMV3T1eggkjLhLmf1q8RuTv9wogE",
        authDomain: "niovi-ai.firebaseapp.com",
        projectId: "niovi-ai",
        storageBucket: "niovi-ai.firebasestorage.app",
        messagingSenderId: "743828032118",
        appId: "1:743828032118:web:fea3e038104e1c84b86d57"
    };

    // âœ… FIX 2: gemini-2.0-flash â€” stable model, Î´Î¿Ï…Î»ÎµÏÎµÎ¹ ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬ ÏƒÏ„Î¿ v1beta
    var GEMINI_API_KEY = "AIzaSyB4Oo2I7dzoYuQdWQs6OuMyJMYn8Bwiljc";
    var GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + GEMINI_API_KEY;

    var APP_ID = 'niovi_enterprise_v2';

    // ===================== STATE =====================
    var user = null;
    var currentChatId = null;
    var currentTab = 'chat';
    var hubSubTab = 'news';
    var localIntel = [];
    var chatListUnsubscribe = null;
    var db, auth;

    var marketNews = [
        { title: "Î‘Î½Î¿Î´Î¹ÎºÎ® Ï€Î¿ÏÎµÎ¯Î± ÏƒÏ„Î¹Ï‚ Î±Î³Î¿ÏÎ­Ï‚ Ï„ÎµÏ‡Î½Î¿Î»Î¿Î³Î¯Î±Ï‚", desc: "ÎŸÎ¹ Î½Î­ÎµÏ‚ ÎµÎ¾ÎµÎ»Î¯Î¾ÎµÎ¹Ï‚ ÏƒÏ„Î¿ AI Ï†Î­ÏÎ½Î¿Ï…Î½ Î±Î¹ÏƒÎ¹Î¿Î´Î¿Î¾Î¯Î±.", source: "MarketWatch" },
        { title: "ÎÎ­Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÏ„Î¿Î½ ÎºÎ»Î¬Î´Î¿ Ï„Î·Ï‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹Î±Ï‚", desc: "Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ­Ï‚ Î±Î»Î»Î±Î³Î­Ï‚ ÏƒÏ„Î¹Ï‚ Ï„Î¹Î¼Î­Ï‚ Ï†Ï…ÏƒÎ¹ÎºÎ¿Ï Î±ÎµÏÎ¯Î¿Ï….", source: "Reuters" }
    ];

    // ===================== INIT FIREBASE =====================
    firebase.initializeApp(FIREBASE_CONFIG);
    auth = firebase.auth();
    db = firebase.firestore();

    auth.onAuthStateChanged(function(u) {
        user = u;
        if (u) {
            setupListeners();
            syncSidebar();
            if (!currentChatId) createNewChat();
        }
    });

    auth.signInAnonymously().catch(function(err) {
        console.error("Auth error:", err);
    });

    // ===================== NAVIGATION =====================
    function setTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.nav-item').forEach(function(i) { i.classList.remove('active'); });
        document.getElementById('nav-' + tab).classList.add('active');
        syncSidebar();
    }

    function setHubSubTab(sub) {
        hubSubTab = sub;
        syncSidebar();
    }

    // ===================== SIDEBAR =====================
    function syncSidebar() {
        var title = document.getElementById('drawer-title');
        var content = document.getElementById('drawer-content');

        if (currentTab === 'chat') {
            title.innerText = "Î£Î¥ÎÎŸÎœÎ™Î›Î™Î•Î£";
            content.innerHTML = '<button class="new-chat-btn" onclick="createNewChat()">+ ÎÎ­Î± Î£Ï…Î½Î¿Î¼Î¹Î»Î¯Î±</button><div id="chat-list"></div>';
            renderChats();
        } else {
            title.innerText = "INTELLIGENCE HUB";
            content.innerHTML =
                '<div class="hub-tabs">' +
                    '<button class="hub-tab-btn ' + (hubSubTab === 'news' ? 'active' : '') + '" onclick="setHubSubTab(\'news\')">News Feed</button>' +
                    '<button class="hub-tab-btn ' + (hubSubTab === 'memory' ? 'active' : '') + '" onclick="setHubSubTab(\'memory\')">Niovi Memory</button>' +
                '</div>' +
                '<div id="hub-container"></div>';
            renderHubContent();
        }
    }

    function renderHubContent() {
        var container = document.getElementById('hub-container');
        if (!container) return;

        if (hubSubTab === 'news') {
            container.innerHTML = marketNews.map(function(n) {
                return '<div class="card">' +
                    '<span class="tag tag-news">' + n.source + '</span>' +
                    '<div class="card-title">' + n.title + '</div>' +
                    '<div class="card-desc">' + n.desc + '</div>' +
                    '</div>';
            }).join('');
        } else {
            container.innerHTML =
                '<div class="memory-train">' +
                    '<textarea id="mem-input" class="memory-input" placeholder="Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„ÏÎ±Ï„Î·Î³Î¹ÎºÎ®Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯Î±Ï‚..."></textarea>' +
                    '<button class="btn-action" onclick="saveToMemory()">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>' +
                '</div>' +
                '<div id="memory-list"></div>';
            renderMemoryList();
        }
    }

    function renderMemoryList() {
        var list = document.getElementById('memory-list');
        if (!list) return;
        if (localIntel.length === 0) {
            list.innerHTML = "<p style='font-size:12px; text-align:center; color:#94a3b8; margin-top:20px;'>ÎšÎµÎ½Î® Î¼Î½Î®Î¼Î·.</p>";
            return;
        }
        list.innerHTML = localIntel.map(function(m) {
            return '<div class="card">' +
                '<span class="tag tag-memory">DATA</span>' +
                '<div class="card-desc">' + m.text + '</div>' +
                '</div>';
        }).join('');
    }

    // ===================== MEMORY =====================
    function saveToMemory() {
        var input = document.getElementById('mem-input');
        var text = input.value.trim();
        if (!text || !user) return;

        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('knowledge')
          .add({ text: text, timestamp: new Date().toISOString(), userId: user.uid })
          .then(function() { input.value = ""; })
          .catch(function(e) { console.error("saveToMemory error:", e); });
    }

    // ===================== CHAT LIST =====================
    function renderChats() {
        if (chatListUnsubscribe) chatListUnsubscribe();

        chatListUnsubscribe = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('sessions')
          .onSnapshot(function(snap) {
            var list = document.getElementById('chat-list');
            if (!list) return;
            list.innerHTML = "";

            var sessions = [];
            snap.forEach(function(d) {
                var data = d.data();
                data._id = d.id;
                sessions.push(data);
            });
            sessions.sort(function(a, b) { return new Date(b.timestamp) - new Date(a.timestamp); });

            sessions.forEach(function(data) {
                var div = document.createElement('div');
                div.className = 'history-item' + (data._id === currentChatId ? ' active' : '');
                div.innerHTML = '<span>ğŸ’¬</span> ' + (data.title || "Î£Ï…Î½Î¿Î¼Î¹Î»Î¯Î±");
                div.onclick = (function(id) {
                    return function() {
                        currentChatId = id;
                        loadChat(id);
                        syncSidebar();
                    };
                })(data._id);
                list.appendChild(div);
            });
        }, function(err) { console.error("Chat list error:", err); });
    }

    // ===================== NEW CHAT =====================
    function createNewChat() {
        var id = "chat_" + Date.now();
        currentChatId = id;
        document.getElementById('chat-window').innerHTML = "";

        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('sessions').doc(id)
          .set({
            title: "Î‘Î½Î¬Î»Ï…ÏƒÎ· " + new Date().toLocaleTimeString('el-GR', {hour:'2-digit', minute:'2-digit'}),
            timestamp: new Date().toISOString()
          })
          .then(function() {
            appendMessage("Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! Î•Î¯Î¼Î±Î¹ Î· Niovi. Î ÏÏ‚ Î¼Ï€Î¿ÏÏ Î½Î± ÏƒÎ±Ï‚ Î²Î¿Î·Î¸Î®ÏƒÏ‰ ÏƒÎ®Î¼ÎµÏÎ±;", "bot");
          })
          .catch(function(e) { console.error("createNewChat error:", e); });
    }

    // ===================== LOAD CHAT =====================
    function loadChat(id) {
        var win = document.getElementById('chat-window');
        win.innerHTML = "";

        db.collection('artifacts').doc(APP_ID).collection('public').doc('data')
          .collection('messages').doc(id).collection('logs')
          .get()
          .then(function(snap) {
            var msgs = [];
            snap.forEach(function(m) { msgs.push(m.data()); });
            msgs.sort(function(a, b) { return new Date(a.timestamp) - new Date(b.timestamp); });

            if (msgs.length === 0) {
                appendMessage("Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! Î•Î¯Î¼Î±Î¹ Î· Niovi. Î ÏÏ‚ Î¼Ï€Î¿ÏÏ Î½Î± ÏƒÎ±Ï‚ Î²Î¿Î·Î¸Î®ÏƒÏ‰ ÏƒÎ®Î¼ÎµÏÎ±;", "bot");
            } else {
                msgs.forEach(function(m) { appendMessage(m.text, m.role); });
            }
          })
          .catch(function(e) {
            console.error("loadChat error:", e);
            appendMessage("Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï.", "bot");
          });
    }

    // ===================== SEND MESSAGE =====================
    async function handleSend() {
        var input = document.getElementById('user-input');
        var text = input.value.trim();
        if (!text || !user || !currentChatId) return;

        appendMessage(text, 'user');
        input.value = "";

        // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data')
          .collection('messages').doc(currentChatId).collection('logs')
          .add({ text: text, role: 'user', timestamp: new Date().toISOString() });

        // Loading indicator
        var loadingDiv = document.createElement('div');
        loadingDiv.className = 'message bot loading-msg';
        loadingDiv.id = 'loading-msg';
        loadingDiv.innerText = 'â³ Î£ÎºÎ­Ï†Ï„Î¿Î¼Î±Î¹...';
        document.getElementById('chat-window').appendChild(loadingDiv);
        document.getElementById('chat-window').scrollTop = 99999;

        try {
            var memText = localIntel.map(function(i) { return i.text; }).join(". ");
            var newsText = marketNews.map(function(n) { return n.title; }).join(". ");

            // âœ… FIX 3: system prompt Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ contents Ï‰Ï‚ Ï€ÏÏÏ„Î¿ Î¼Î®Î½Ï…Î¼Î± â€” Ï€Î¹Î¿ ÏƒÏ…Î¼Î²Î±Ï„ÏŒ
            var systemPrompt = "Î•Î¯ÏƒÎ±Î¹ Î· Niovi AI, ÏƒÏ„ÏÎ±Ï„Î·Î³Î¹ÎºÏŒÏ‚ Î²Î¿Î·Î¸ÏŒÏ‚ ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÎ®ÏƒÎµÏ‰Î½. Î‘Ï€Î¬Î½Ï„Î± ÏƒÏ„Î± Î•Î»Î»Î·Î½Î¹ÎºÎ¬. Î‘Ï€Î¬Î½Ï„Î± Î¼ÏŒÎ½Î¿ ÏƒÎµ ÏŒ,Ï„Î¹ ÏƒÎµ ÏÏ‰Ï„Î¬Î½Îµ." +
                (memText ? " Î”ÎµÎ´Î¿Î¼Î­Î½Î± Î¼Î½Î®Î¼Î·Ï‚: " + memText + "." : "") +
                (newsText ? " Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Î½Î­Î±: " + newsText + "." : "");

            var response = await fetch(GEMINI_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [
                        { role: "user", parts: [{ text: systemPrompt + "\n\nÎ•ÏÏÏ„Î·ÏƒÎ·: " + text }] }
                    ]
                })
            });

            var data = await response.json();

            if (!response.ok) {
                console.error("Gemini API error:", data);
                throw new Error("API error " + response.status);
            }

            var reply = (data.candidates && data.candidates[0] && data.candidates[0].content.parts[0].text)
                || "Î”ÎµÎ½ Î­Î»Î±Î²Î± Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.";

            var loading = document.getElementById('loading-msg');
            if (loading) loading.remove();
            appendMessage(reply, 'bot');

            // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚ bot
            db.collection('artifacts').doc(APP_ID).collection('public').doc('data')
              .collection('messages').doc(currentChatId).collection('logs')
              .add({ text: reply, role: 'bot', timestamp: new Date().toISOString() });

        } catch(e) {
            console.error("handleSend error:", e);
            var loading = document.getElementById('loading-msg');
            if (loading) loading.remove();
            appendMessage("âš ï¸ Î£Ï†Î¬Î»Î¼Î± API. Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿ console (F12).", "bot");
        }
    }

    // ===================== APPEND MESSAGE =====================
    function appendMessage(text, role) {
        var win = document.getElementById('chat-window');
        if (!win) return;
        var div = document.createElement('div');
        div.className = 'message ' + role;
        div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    // ===================== SETUP LISTENERS =====================
    function setupListeners() {
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('knowledge')
          .onSnapshot(function(snap) {
            localIntel = [];
            snap.forEach(function(d) { localIntel.push(d.data()); });
            if (currentTab === 'intel' && hubSubTab === 'memory') renderMemoryList();
          }, function(err) { console.error("Knowledge listener error:", err); });
    }

    // Enter key
    document.getElementById('user-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleSend();
    });
</script>
</body>
</html>
